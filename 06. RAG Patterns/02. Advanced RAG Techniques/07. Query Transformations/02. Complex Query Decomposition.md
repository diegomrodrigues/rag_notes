## Decomposi√ß√£o de Queries Complexas em Sub-Queries para Recupera√ß√£o Aprimorada

### Introdu√ß√£o
Em sistemas de Neural Information Retrieval (NIR) e Retrieval-Augmented Generation (RAG) com Large Language Models (LLMs), a capacidade de lidar com queries complexas √© crucial para fornecer respostas precisas e contextualmente relevantes. Quando confrontados com uma query multifacetada, a recupera√ß√£o direta de informa√ß√µes pode ser inadequada, resultando em respostas sub√≥timas. Uma estrat√©gia eficaz para mitigar este problema √© decompor a query original em sub-queries mais simples e focadas, que facilitam a recupera√ß√£o de informa√ß√µes concretas. Este cap√≠tulo explora a decomposi√ß√£o de queries complexas, abordando sua implementa√ß√£o atrav√©s do Multi Query Retriever (Langchain) e do Sub Question Query Engine (Llamaindex).

### Conceitos Fundamentais
A decomposi√ß√£o de queries complexas envolve a utiliza√ß√£o de um LLM para analisar a query original e gerar um conjunto de sub-queries independentes, cada uma focada em um aspecto espec√≠fico da query original. Essas sub-queries s√£o ent√£o executadas em paralelo contra a base de conhecimento, e os resultados s√£o agregados para sintetizar uma resposta final. Este processo permite que o sistema RAG explore diferentes dimens√µes da query, garantindo uma recupera√ß√£o mais completa e precisa.

**Vantagens da Decomposi√ß√£o de Queries:**
*   **Maior Precis√£o:** Sub-queries focadas resultam em recupera√ß√£o de informa√ß√µes mais relevantes.
*   **Cobertura Abrangente:** Explora√ß√£o de diferentes aspectos da query, garantindo respostas completas.
*   **Paraleliza√ß√£o:** Execu√ß√£o paralela de sub-queries para efici√™ncia.

Al√©m dessas vantagens, a decomposi√ß√£o de queries permite a aplica√ß√£o de diferentes estrat√©gias de recupera√ß√£o para cada sub-query, otimizando ainda mais o processo. Por exemplo, sub-queries que requerem informa√ß√µes factuais podem se beneficiar de buscas em bancos de dados estruturados, enquanto sub-queries que demandam an√°lise de texto podem utilizar modelos de similaridade sem√¢ntica.

**Teorema 1** (Otimiza√ß√£o da Recupera√ß√£o via Estrat√©gias Heterog√™neas): A decomposi√ß√£o de uma query complexa em sub-queries permite a aplica√ß√£o de estrat√©gias de recupera√ß√£o otimizadas individualmente para cada sub-query, resultando em um aumento significativo na precis√£o e relev√¢ncia da resposta final, comparado √† aplica√ß√£o de uma √∫nica estrat√©gia de recupera√ß√£o para a query original.

*Prova (Esbo√ßo):* A prova se baseia na ideia de que diferentes sub-queries podem requerer diferentes tipos de informa√ß√£o e, portanto, diferentes m√©todos de recupera√ß√£o. Formalmente, seja *$Q$* a query original e *$S = \{s_1, s_2, \ldots, s_n\}$* o conjunto de sub-queries resultantes da decomposi√ß√£o. Seja *$R_i$* a estrat√©gia de recupera√ß√£o otimizada para a sub-query *$s_i$*. Ao aplicar *$R_i$* a *$s_i$*, obtemos um conjunto de documentos *$D_i$* que s√£o altamente relevantes para *$s_i$*. A uni√£o dos conjuntos *$D_i$* resulta em um conjunto de documentos mais completo e relevante para a query original *$Q$* do que o obtido pela aplica√ß√£o de uma √∫nica estrat√©gia *$R$* diretamente em *$Q$*. $\blacksquare$

> üí° **Exemplo Num√©rico:**
> Suponha que temos uma query complexa *$Q$*: "Quais s√£o os efeitos da dieta cetog√™nica no desempenho cognitivo e na sa√∫de cardiovascular?". Podemos decompor essa query em duas sub-queries:
> *   *$s_1$*: "Efeitos da dieta cetog√™nica no desempenho cognitivo."
> *   *$s_2$*: "Efeitos da dieta cetog√™nica na sa√∫de cardiovascular."
>
> Para *$s_1$*, podemos usar uma estrat√©gia de recupera√ß√£o *$R_1$* que prioriza artigos cient√≠ficos com estudos cl√≠nicos randomizados (RCTs) sobre cogni√ß√£o. Para *$s_2$*, podemos usar uma estrat√©gia *$R_2$* que foca em estudos epidemiol√≥gicos e meta-an√°lises sobre sa√∫de cardiovascular.
>
> Digamos que *$R_1$* retorna 5 documentos (*$D_1$*) e *$R_2$* retorna 7 documentos (*$D_2$*). Se us√°ssemos apenas uma estrat√©gia *$R$* gen√©rica, poder√≠amos obter apenas 8 documentos, alguns dos quais poderiam ser menos relevantes para aspectos espec√≠ficos da query original.  Portanto, a decomposi√ß√£o e o uso de estrat√©gias heterog√™neas nos permite obter mais informa√ß√µes relevantes.

#### Multi Query Retriever (Langchain)
O Multi Query Retriever, implementado em Langchain, automatiza o processo de decomposi√ß√£o de queries. Ele utiliza um LLM para gerar m√∫ltiplas varia√ß√µes da query original, cada uma formulada para capturar nuances espec√≠ficas da inten√ß√£o do usu√°rio. Essas varia√ß√µes s√£o ent√£o usadas para consultar a base de conhecimento, e os resultados s√£o combinados para fornecer uma resposta abrangente.

**Exemplo:**
Suponha que a query original seja: "Compare a efic√°cia e os efeitos colaterais de dois medicamentos para tratar a hipertens√£o, considerando pacientes com diabetes". O Multi Query Retriever pode gerar as seguintes sub-queries:
1.  "Qual a efic√°cia do medicamento A no tratamento da hipertens√£o?"
2.  "Quais os efeitos colaterais do medicamento A?"
3.  "Qual a efic√°cia do medicamento B no tratamento da hipertens√£o?"
4.  "Quais os efeitos colaterais do medicamento B?"
5.  "Como a diabetes afeta o tratamento da hipertens√£o com o medicamento A?"
6.  "Como a diabetes afeta o tratamento da hipertens√£o com o medicamento B?"

Cada uma dessas sub-queries √© executada individualmente, e os resultados s√£o combinados para fornecer uma resposta comparativa detalhada.

**Teorema 1.1** (Gera√ß√£o de Sub-Queries Sem√¢nticas): O Multi Query Retriever, ao gerar m√∫ltiplas varia√ß√µes sem√¢nticas da query original, maximiza a cobertura de nuances informacionais relevantes, resultando em uma recupera√ß√£o mais robusta e completa em compara√ß√£o com a utiliza√ß√£o de uma √∫nica query.

*Prova (Esbo√ßo):* Seja Q a query original e {Q1, Q2, ..., Qn} o conjunto de varia√ß√µes sem√¢nticas geradas pelo Multi Query Retriever. Cada Qi representa uma perspectiva diferente sobre Q. A uni√£o das informa√ß√µes recuperadas por cada Qi cobre um espa√ßo informacional maior do que a informa√ß√£o recuperada apenas por Q. Formalmente, seja I(Qi) o conjunto de informa√ß√µes recuperadas por Qi. Ent√£o, U(I(Qi)) para i=1 at√© n √© um superconjunto de I(Q), implicando uma cobertura informacional superior. $\blacksquare$

> üí° **Exemplo Num√©rico:**
>
> Considere a query original: "Melhores restaurantes italianos em S√£o Paulo com op√ß√µes vegetarianas e bom custo-benef√≠cio". O Multi Query Retriever pode gerar as seguintes sub-queries:
> 1. "Restaurantes italianos em S√£o Paulo."
> 2. "Restaurantes vegetarianos em S√£o Paulo."
> 3. "Restaurantes baratos em S√£o Paulo."
> 4. "Restaurantes italianos com op√ß√µes vegetarianas em S√£o Paulo."
> 5. "Restaurantes italianos com bom custo-benef√≠cio em S√£o Paulo."
>
> Suponha que cada sub-query retorna os seguintes n√∫meros de documentos relevantes:
>
> | Sub-Query                                                  | N√∫mero de Documentos |
> | :--------------------------------------------------------- | :------------------- |
> | Restaurantes italianos em S√£o Paulo                       | 50                   |
> | Restaurantes vegetarianos em S√£o Paulo                       | 30                   |
> | Restaurantes baratos em S√£o Paulo                            | 40                   |
> | Restaurantes italianos com op√ß√µes vegetarianas em S√£o Paulo | 15                   |
> | Restaurantes italianos com bom custo-benef√≠cio em S√£o Paulo  | 20                   |
>
> Se simplesmente procurarmos pela query original, podemos perder informa√ß√µes valiosas. Ao gerar sub-queries, garantimos que estamos considerando todos os aspectos importantes (culin√°ria italiana, op√ß√µes vegetarianas, custo-benef√≠cio) para encontrar os melhores restaurantes. A uni√£o dos resultados garante uma cobertura mais ampla.

#### Sub Question Query Engine (Llamaindex)
O Sub Question Query Engine, presente em Llamaindex, adota uma abordagem similar, mas com foco na estrutura da query. Ele analisa a query original para identificar as principais sub-perguntas que precisam ser respondidas para satisfazer a solicita√ß√£o do usu√°rio. Cada sub-pergunta √© ent√£o tratada como uma query separada, e os resultados s√£o integrados para formar a resposta final.

**Funcionamento:**
1.  **An√°lise da Query:** O LLM analisa a query para identificar as sub-perguntas.
2.  **Gera√ß√£o de Sub-Queries:** Sub-queries espec√≠ficas s√£o formuladas para responder a cada sub-pergunta.
3.  **Execu√ß√£o Paralela:** As sub-queries s√£o executadas em paralelo.
4.  **Agrega√ß√£o de Resultados:** Os resultados s√£o combinados e sintetizados em uma resposta final.

**Exemplo:**
Considerando a mesma query "Compare a efic√°cia e os efeitos colaterais de dois medicamentos para tratar a hipertens√£o, considerando pacientes com diabetes", o Sub Question Query Engine pode identificar as seguintes sub-perguntas:
1.  "Qual a efic√°cia do medicamento A?"
2.  "Quais os efeitos colaterais do medicamento A?"
3.  "Qual a efic√°cia do medicamento B?"
4.  "Quais os efeitos colaterais do medicamento B?"
5.  "Como a diabetes influencia a efic√°cia e os efeitos colaterais do medicamento A?"
6.  "Como a diabetes influencia a efic√°cia e os efeitos colaterais do medicamento B?"

A partir dessas sub-perguntas, o sistema gera e executa sub-queries correspondentes, agregando os resultados para formar uma resposta completa.

Para otimizar ainda mais o Sub Question Query Engine, pode-se introduzir um mecanismo de pondera√ß√£o de sub-perguntas, atribuindo pesos diferentes a cada sub-pergunta com base em sua relev√¢ncia para a query original.

**Proposi√ß√£o 1** (Pondera√ß√£o de Sub-Perguntas): Atribuir pesos diferentes a cada sub-pergunta com base em sua import√¢ncia relativa para a query original pode melhorar a precis√£o da resposta final, direcionando o foco do sistema para os aspectos mais cr√≠ticos da solicita√ß√£o do usu√°rio.

*Prova (Esbo√ßo):* Seja *$Q$* a query original e *$S = \{s_1, s_2, \ldots, s_n\}$* o conjunto de sub-perguntas. Seja *$w_i$* o peso atribu√≠do √† sub-pergunta *$s_i$*, onde *$0 \leq w_i \leq 1$* e *$\sum w_i = 1$*. Ao ponderar os resultados de cada sub-query com seu respectivo peso, o sistema enfatiza as informa√ß√µes mais relevantes, mitigando o impacto de informa√ß√µes menos importantes ou ru√≠do. A resposta final, portanto, reflete com maior precis√£o a inten√ß√£o do usu√°rio. $\blacksquare$

> üí° **Exemplo Num√©rico:**
>
> Vamos usar a query: "Explique a teoria da relatividade geral e suas implica√ß√µes para buracos negros e a expans√£o do universo."
>
> O Sub Question Query Engine pode gerar as seguintes sub-perguntas:
> 1. "O que √© a teoria da relatividade geral?"
> 2. "Quais s√£o as implica√ß√µes da relatividade geral para buracos negros?"
> 3. "Quais s√£o as implica√ß√µes da relatividade geral para a expans√£o do universo?"
>
> Podemos atribuir pesos a estas sub-perguntas, considerando que a compreens√£o da teoria geral (sub-pergunta 1) √© fundamental para entender as demais:
> *   *$w_1$* (Relatividade Geral) = 0.5
> *   *$w_2$* (Buracos Negros) = 0.3
> *   *$w_3$* (Expans√£o do Universo) = 0.2
>
> Suponha que a relev√¢ncia dos documentos recuperados para cada sub-pergunta, ap√≥s a busca, seja avaliada em uma escala de 0 a 1.
>
> | Sub-Pergunta                       | Peso (w<sub>i</sub>) | Relev√¢ncia M√©dia (ap√≥s busca) | Pontua√ß√£o Ponderada |
> | :--------------------------------- | :------------- | :----------------------------- | :------------------ |
> | O que √© a relatividade geral?     | 0.5            | 0.9                           | 0.45                |
> | Implica√ß√µes para buracos negros    | 0.3            | 0.8                           | 0.24                |
> | Implica√ß√µes para expans√£o do universo | 0.2            | 0.7                           | 0.14                |
> | **Total**                          |                |                                | **0.83**            |
>
> A pontua√ß√£o ponderada total (0.83) reflete a relev√¢ncia geral da resposta, levando em considera√ß√£o a import√¢ncia relativa de cada sub-pergunta. Este m√©todo garante que a resposta final reflita adequadamente a profundidade de cada aspecto da query original.

### Conclus√£o
A decomposi√ß√£o de queries complexas em sub-queries √© uma t√©cnica poderosa para melhorar a precis√£o e a abrang√™ncia da recupera√ß√£o de informa√ß√µes em sistemas RAG. Tanto o Multi Query Retriever (Langchain) quanto o Sub Question Query Engine (Llamaindex) oferecem implementa√ß√µes eficazes desta estrat√©gia, permitindo que os LLMs lidem com queries multifacetadas de forma mais eficiente. Ao explorar diferentes aspectos da query atrav√©s de sub-queries paralelas, estes sistemas garantem que nenhuma informa√ß√£o relevante seja negligenciada, resultando em respostas mais completas e contextualmente ricas. A aplica√ß√£o de estrat√©gias de recupera√ß√£o heterog√™neas e a pondera√ß√£o de sub-perguntas podem otimizar ainda mais o processo, refinando a precis√£o e a relev√¢ncia das respostas geradas.

### Refer√™ncias
Nenhuma refer√™ncia fornecida no contexto.
<!-- END -->